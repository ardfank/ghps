stages:
  - sonar
  - build
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Dp2.repo.zk=file:../binary.file/p2.zk/10.0.1 -Dp2.repo.repackaged=file:../binary.file/p2.repackaged/12.0.0 -Dp2.repo.jasperstudio=file:../binary.file/p2.repackaged/jasperstudio/6.17.0"

default:
  image:
    name: docker
    entrypoint: [""]
  tags:
    - docker-runner
  before_script:
    - apk add --no-cache git openjdk17 maven

sonar:
  stage: sonar
  cache:
    key: sonar
    paths:
      - .sonar/cache
      - .m2/repository
  script:
    - rm -rf /cache/idempiere-server || true
    - git clone --depth=1 --branch master --single-branch https://github.com/idempiere/binary.file.git binary.file
    - git clone --depth=1 --branch massup-12-demo --single-branch https://$BITTOKEN@bitbucket.org/forca/idempiere-forca.git idempiere-forca
    - git clone --depth=1 --branch massup-12-demo --single-branch https://$BITTOKEN@bitbucket.org/forca/plugins-erp.git plugins-erp
    - cd idempiere-forca
    - >
      mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:5.0.0.4389:sonar
      -Dsonar.projectKey=${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}
      -Dsonar.sources=. -Dsonar.projectName="${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}"
      -Dsonar.exclusions=**/I_*.java,**/X_*.java
      -Dsonar.host.url=http://10.0.2.21:8081
      -Dsonar.sourceEncoding=UTF-8
      -Dsonar.scanner.javaOpts="-Xmx6g"
      -Dsonar.issue.ignore.multicriteria=e1,e2
      -Dsonar.issue.ignore.multicriteria.e1.ruleKey=java:S3252
      -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*.java
      -Dsonar.issue.ignore.multicriteria.e2.ruleKey=java:S117
      -Dsonar.issue.ignore.multicriteria.e2.resourceKey=**/*.java
      -Dsonar.token=$SONARTOKEN
      -Dsonar.qualitygate.wait=true
    - mkdir -p /cache/idempiere-server
    - cp -r org.idempiere.p2/target/products/org.adempiere.server.product/linux/gtk/x86_64/* /cache/idempiere-server

build:
  stage: build
  script:
    - cp ../Dockerfile /cache/idempiere-server/Dockerfile
    - cp ../docker-entrypoint.sh /cache/idempiere-server/docker-entrypoint.sh
    - cd /cache/idempiere-server/
    - docker build -t forca-erp:latest .
    
deploy:
  stage: deploy
  script:
    - docker-compose -f docker-compose.yml up -d --force-recreate
